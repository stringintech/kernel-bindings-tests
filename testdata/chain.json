{
  "name": "Chain",
  "description": "Sets up blocks, checks chain state, and verifies that the chain tip changes as expected after a reorg scenario",
  "stateful": true,
  "tests": [
    {
      "description": "Create context with regtest chain parameters",
      "request": {
        "id": "chain#1",
        "method": "btck_context_create",
        "params": {
          "chain_parameters": {
            "chain_type": "btck_ChainType_REGTEST"
          }
        },
        "ref": "$context_ref"
      },
      "expected_response": {
        "result": "$context_ref"
      }
    },
    {
      "description": "Create chainstate manager from context",
      "request": {
        "id": "chain#2",
        "method": "btck_chainstate_manager_create",
        "params": {
          "context": "$context_ref"
        },
        "ref": "$chainstate_manager_ref"
      },
      "expected_response": {
        "result": "$chainstate_manager_ref"
      }
    },
    {
      "description": "Destroy context as it's no longer needed",
      "request": {
        "id": "chain#3",
        "method": "btck_context_destroy",
        "params": {
          "context": "$context_ref"
        }
      },
      "expected_response": {
        "result": null
      }
    },
    {
      "description": "Get active chain reference from chainstate manager",
      "request": {
        "id": "chain#4",
        "method": "btck_chainstate_manager_get_active_chain",
        "params": {
          "chainstate_manager": "$chainstate_manager_ref"
        },
        "ref": "$chain_ref"
      },
      "expected_response": {
        "result": "$chain_ref"
      }
    },
    {
      "description": "Assert chain height is 0 (genesis block only)",
      "request": {
        "id": "chain#5",
        "method": "btck_chain_get_height",
        "params": {
          "chain": "$chain_ref"
        }
      },
      "expected_response": {
        "result": 0
      }
    },
    {
      "description": "Create block 1 from raw hex data",
      "request": {
        "id": "chain#6",
        "method": "btck_block_create",
        "params": {
          "raw_block": "0000002006226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f35b99ed4e2e165de2ad77f1bba48049358c9bb740445f3c83ebdb3e83aa5bca8dbe5494dffff7f200000000001020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff025100feffffff0200f2052a010000001976a9142b4569203694fc997e13f2c0a1383b9e16c77a0d88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000000000000"
        },
        "ref": "$block_1_ref"
      },
      "expected_response": {
        "result": "$block_1_ref"
      }
    },
    {
      "description": "Process block 1, extending chain to height 1",
      "request": {
        "id": "chain#7",
        "method": "btck_chainstate_manager_process_block",
        "params": {
          "chainstate_manager": "$chainstate_manager_ref",
          "block": "$block_1_ref"
        }
      },
      "expected_response": {
        "result": {
          "new_block": true
        }
      }
    },
    {
      "description": "Create block 2 from raw hex data",
      "request": {
        "id": "chain#8",
        "method": "btck_block_create",
        "params": {
          "raw_block": "000000205e2f859d70e29641f32371f3bf17a282466ad851f9e51b44a70738abeace314a9cf876c62dbbe036af4ea4a7363cd4ca1c14c8572095cba3b76a87daa1303ed8dce5494dffff7f200200000001020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff025200feffffff0200f2052a010000001976a9142b4569203694fc997e13f2c0a1383b9e16c77a0d88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000001000000"
        },
        "ref": "$block_2_ref"
      },
      "expected_response": {
        "result": "$block_2_ref"
      }
    },
    {
      "description": "Process block 2, extending chain to height 2",
      "request": {
        "id": "chain#9",
        "method": "btck_chainstate_manager_process_block",
        "params": {
          "chainstate_manager": "$chainstate_manager_ref",
          "block": "$block_2_ref"
        }
      },
      "expected_response": {
        "result": {
          "new_block": true
        }
      }
    },
    {
      "description": "Create block 3 from raw hex data",
      "request": {
        "id": "chain#10",
        "method": "btck_block_create",
        "params": {
          "raw_block": "0000002077622c1ae937c9fec6be84d01521cb31b0e6f88ec48150965323dba6a1e36e19354352df0f2a5d635ca7d3a52064f9c95f070d2c13c0a6c087acba03dfeeae66dde5494dffff7f200000000001020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff025300feffffff0200f2052a010000001976a9142b4569203694fc997e13f2c0a1383b9e16c77a0d88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000002000000"
        },
        "ref": "$block_3_ref"
      },
      "expected_response": {
        "result": "$block_3_ref"
      }
    },
    {
      "description": "Process block 3, extending chain to height 3",
      "request": {
        "id": "chain#11",
        "method": "btck_chainstate_manager_process_block",
        "params": {
          "chainstate_manager": "$chainstate_manager_ref",
          "block": "$block_3_ref"
        }
      },
      "expected_response": {
        "result": {
          "new_block": true
        }
      }
    },
    {
      "description": "Assert chain height is 3 after processing blocks",
      "request": {
        "id": "chain#12",
        "method": "btck_chain_get_height",
        "params": {
          "chain": "$chain_ref"
        }
      },
      "expected_response": {
        "result": 3
      }
    },
    {
      "description": "Get block tree entry at height 3 to use after reorg",
      "request": {
        "id": "chain#13",
        "method": "btck_chain_get_by_height",
        "params": {
          "chain": "$chain_ref",
          "block_height": 3
        },
        "ref": "$tip_entry_ref"
      },
      "expected_response": {
        "result": "$tip_entry_ref"
      }
    },
    {
      "description": "Assert tip block hash matches expected value",
      "request": {
        "id": "chain#14",
        "method": "btck_block_tree_entry_get_block_hash",
        "params": {
          "block_tree_entry": "$tip_entry_ref"
        }
      },
      "expected_response": {
        "result": "1a81e97231fb262ccf464f937553a1deff996ac6901b062d0b35afe025ee2886"
      }
    },
    {
      "description": "Create reorg block 1 (competing block at height 2)",
      "request": {
        "id": "chain#15",
        "method": "btck_block_create",
        "params": {
          "raw_block": "000000205e2f859d70e29641f32371f3bf17a282466ad851f9e51b44a70738abeace314a9cf876c62dbbe036af4ea4a7363cd4ca1c14c8572095cba3b76a87daa1303ed8dee5494dffff7f200000000001020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff025200feffffff0200f2052a010000001976a9142b4569203694fc997e13f2c0a1383b9e16c77a0d88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000001000000"
        },
        "ref": "$reorg_block_1_ref"
      },
      "expected_response": {
        "result": "$reorg_block_1_ref"
      }
    },
    {
      "description": "Process reorg block 1",
      "request": {
        "id": "chain#16",
        "method": "btck_chainstate_manager_process_block",
        "params": {
          "chainstate_manager": "$chainstate_manager_ref",
          "block": "$reorg_block_1_ref"
        }
      },
      "expected_response": {
        "result": {
          "new_block": true
        }
      }
    },
    {
      "description": "Create reorg block 2 (competing block at height 3)",
      "request": {
        "id": "chain#17",
        "method": "btck_block_create",
        "params": {
          "raw_block": "000000202c6c418b1f714cbe22c9c2906a5c1a3f5c0df22d32989b71f579b2289a0ccd4c354352df0f2a5d635ca7d3a52064f9c95f070d2c13c0a6c087acba03dfeeae66dfe5494dffff7f200200000001020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff025300feffffff0200f2052a010000001976a9142b4569203694fc997e13f2c0a1383b9e16c77a0d88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000002000000"
        },
        "ref": "$reorg_block_2_ref"
      },
      "expected_response": {
        "result": "$reorg_block_2_ref"
      }
    },
    {
      "description": "Process reorg block 2",
      "request": {
        "id": "chain#18",
        "method": "btck_chainstate_manager_process_block",
        "params": {
          "chainstate_manager": "$chainstate_manager_ref",
          "block": "$reorg_block_2_ref"
        }
      },
      "expected_response": {
        "result": {
          "new_block": true
        }
      }
    },
    {
      "description": "Create reorg block 3 (extending chain to height 4, triggering reorg)",
      "request": {
        "id": "chain#19",
        "method": "btck_block_create",
        "params": {
          "raw_block": "00000020732f2f7a1035b802d670218031da2b11d0fe7297ddaeb4a428fc51bf588770417bd00ba57498a2dfcf4e3f0d7ef7f279b254fc422133f300a49aed3c8ed7717fe0e5494dffff7f200100000001020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff025400feffffff0200f2052a010000001976a9142b4569203694fc997e13f2c0a1383b9e16c77a0d88ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000003000000"
        },
        "ref": "$reorg_block_3_ref"
      },
      "expected_response": {
        "result": "$reorg_block_3_ref"
      }
    },
    {
      "description": "Process reorg block 3, triggering chain reorganization",
      "request": {
        "id": "chain#20",
        "method": "btck_chainstate_manager_process_block",
        "params": {
          "chainstate_manager": "$chainstate_manager_ref",
          "block": "$reorg_block_3_ref"
        }
      },
      "expected_response": {
        "result": {
          "new_block": true
        }
      }
    },
    {
      "description": "Assert chain height is 4 after processing reorg block 3",
      "request": {
        "id": "chain#21",
        "method": "btck_chain_get_height",
        "params": {
          "chain": "$chain_ref"
        }
      },
      "expected_response": {
        "result": 4
      }
    },
    {
      "description": "Verify that the old tip is no longer in the active chain after reorg",
      "request": {
        "id": "chain#22",
        "method": "btck_chain_contains",
        "params": {
          "chain": "$chain_ref",
          "block_tree_entry": "$tip_entry_ref"
        }
      },
      "expected_response": {
        "result": false
      }
    },
    {
      "description": "Get block tree entry at height 4 (new tip after reorg)",
      "request": {
        "id": "chain#23",
        "method": "btck_chain_get_by_height",
        "params": {
          "chain": "$chain_ref",
          "block_height": 4
        },
        "ref": "$new_tip_entry_ref"
      },
      "expected_response": {
        "result": "$new_tip_entry_ref"
      }
    },
    {
      "description": "Assert new tip block hash matches expected value after reorg",
      "request": {
        "id": "chain#24",
        "method": "btck_block_tree_entry_get_block_hash",
        "params": {
          "block_tree_entry": "$new_tip_entry_ref"
        }
      },
      "expected_response": {
        "result": "18618dcf64dddb10ea15d7850bc4c7965c9a72b613da8530b83057672f29bbfa"
      }
    },
    {
      "description": "Destroy chainstate manager",
      "request": {
        "id": "chain#25",
        "method": "btck_chainstate_manager_destroy",
        "params": {
          "chainstate_manager": "$chainstate_manager_ref"
        }
      },
      "expected_response": {
        "result": null
      }
    }
  ]
}